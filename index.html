<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>منصة واد الرمان - الإصدار المستقر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        darkBg: '#0f172a', 
                        darkCard: '#1e293b',
                        primary: '#0d9488',
                        secondary: '#0f766e'
                    },
                    borderRadius: { '4xl': '2rem', '5xl': '2.5rem' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Tajawal', sans-serif; transition: background-color 0.4s ease; }
        .dark body { background-color: #0f172a; color: #f1f5f9; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .book-spine {
            position: relative;
            transition: all 0.4s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .book-spine:hover {
            transform: rotateY(-20deg) scale(1.05);
        }

        .page-content { display: none; }
        .page-content.active { display: block; animation: slideUp 0.5s ease-out; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-item { transition: all 0.3s ease; }
        .active-nav { 
            background: linear-gradient(to left, rgba(13, 148, 136, 0.1), transparent);
            color: #0d9488; 
            border-right: 4px solid #0d9488; 
        }
        .dark .active-nav { color: #5eead4; border-right-color: #5eead4; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased overflow-x-hidden">

    <!-- Toast Notifications -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] px-8 py-4 rounded-2xl shadow-2xl opacity-0 translate-y-20 transition-all duration-500 flex items-center gap-3">
        <span id="toast-msg" class="font-bold"></span>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 opacity-0 invisible transition-all duration-300 backdrop-blur-sm">
        <div class="bg-white dark:bg-darkCard w-full max-w-md rounded-[3rem] p-10 relative shadow-2xl border dark:border-slate-700">
            <button onclick="closeAuthModal()" class="absolute top-6 left-6 text-slate-400 hover:text-rose-500 transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div id="login-form">
                <div class="text-center mb-10">
                    <div class="w-16 h-16 bg-teal-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-teal-600/20">
                        <i data-lucide="log-in" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-3xl font-black dark:text-white mb-2">تسجيل الدخول</h2>
                    <p class="text-slate-500">مرحباً بعودتك لطالب العلم</p>
                </div>
                <div class="space-y-4 mb-8">
                    <div class="relative">
                        <i data-lucide="mail" class="absolute right-4 top-4 w-5 h-5 text-slate-400"></i>
                        <input type="email" id="login-email" placeholder="البريد الإلكتروني" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 pr-12 outline-none dark:text-white border-2 border-transparent focus:border-teal-500 transition-all">
                    </div>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute right-4 top-4 w-5 h-5 text-slate-400"></i>
                        <input type="password" id="login-pass" placeholder="كلمة المرور" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 pr-12 outline-none dark:text-white border-2 border-transparent focus:border-teal-500 transition-all">
                    </div>
                </div>
                <button onclick="handleLogin()" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-teal-700 hover:shadow-xl hover:shadow-teal-600/20 transition-all">دخول آمن</button>
                <p class="text-center mt-6 text-slate-500">ليس لديك حساب؟ <a href="javascript:void(0)" onclick="toggleAuthForms('signup')" class="text-teal-600 font-bold hover:underline">سجل الآن</a></p>
            </div>

            <div id="signup-form" class="hidden">
                <div class="text-center mb-10">
                    <div class="w-16 h-16 bg-teal-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 shadow-lg shadow-teal-600/20">
                        <i data-lucide="user-plus" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-3xl font-black dark:text-white mb-2">حساب جديد</h2>
                    <p class="text-slate-500">ابدأ رحلتك التعليمية معنا</p>
                </div>
                <div class="space-y-4 mb-8">
                    <input type="text" id="reg-name" placeholder="الاسم الكامل" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 outline-none dark:text-white border-2 border-transparent focus:border-teal-500 transition-all">
                    <input type="email" id="reg-email" placeholder="البريد الإلكتروني" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 outline-none dark:text-white border-2 border-transparent focus:border-teal-500 transition-all">
                    <input type="password" id="reg-pass" placeholder="كلمة المرور" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 outline-none dark:text-white border-2 border-transparent focus:border-teal-500 transition-all">
                </div>
                <button onclick="handleSignup()" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-teal-700 transition-all shadow-lg">إنشاء الحساب</button>
                <p class="text-center mt-6 text-slate-500">لديك حساب بالفعل؟ <a href="javascript:void(0)" onclick="toggleAuthForms('login')" class="text-teal-600 font-bold hover:underline">دخول</a></p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="main-sidebar" class="fixed right-0 top-0 h-full w-72 bg-white dark:bg-darkCard border-l dark:border-slate-800 shadow-2xl z-50 flex flex-col">
        <div class="p-8 flex items-center gap-4 border-b dark:border-slate-800">
            <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-teal-700 rounded-2xl flex items-center justify-center text-white font-black text-2xl shadow-lg shadow-teal-500/20">و</div>
            <div>
                <div class="text-xl font-black dark:text-white tracking-tight">واد الرمان</div>
                <div class="text-[10px] text-teal-600 font-bold uppercase tracking-widest">Islamic Academy</div>
            </div>
        </div>
        
        <nav class="flex-grow p-6 space-y-2 mt-4 overflow-y-auto">
            <div onclick="navigateTo('home')" id="nav-home" class="nav-item active-nav flex items-center gap-4 p-4 rounded-2xl cursor-pointer">
                <i data-lucide="layout-grid" class="w-5 h-5"></i><span class="font-bold">الرئيسية</span>
            </div>
            <div onclick="protectedNavigation('subjects')" id="nav-subjects" class="nav-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="book-open" class="w-5 h-5"></i><span class="font-bold">المواد التعليمية</span>
            </div>
            <div onclick="protectedNavigation('challenge')" id="nav-challenge" class="nav-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="zap" class="w-5 h-5"></i><span class="font-bold">تحدي الوقت</span>
            </div>
            <div onclick="protectedNavigation('quizzes')" id="nav-quizzes" class="nav-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="check-circle-2" class="w-5 h-5"></i><span class="font-bold">اختبارات متنوعة</span>
            </div>
            <div onclick="protectedNavigation('library')" id="nav-library" class="nav-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="library" class="w-5 h-5"></i><span class="font-bold">المكتبة</span>
            </div>
            <div onclick="protectedNavigation('leaderboard')" id="nav-leaderboard" class="nav-item flex items-center gap-4 p-4 rounded-2xl cursor-pointer text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <i data-lucide="award" class="w-5 h-5"></i><span class="font-bold">لوحة التميز</span>
            </div>
        </nav>

        <!-- Developer Credit -->
        <div class="px-6 py-4 border-t dark:border-slate-800 text-center bg-slate-50/30 dark:bg-slate-900/10">
            <p class="text-[9px] text-slate-400 font-bold mb-0.5 uppercase tracking-widest">تصميم وتطوير</p>
            <p class="text-xs font-black text-teal-600 dark:text-teal-400 tracking-tight">شاوشي إبراهيم</p>
        </div>

        <div class="p-6 border-t dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/20">
            <div id="auth-sidebar-actions"></div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="lg:mr-72 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="sticky top-0 z-40 bg-white/70 dark:bg-darkCard/70 backdrop-blur-xl p-6 border-b dark:border-slate-800 flex items-center justify-between">
            <div class="relative w-full max-w-lg">
                <input id="globalSearch" type="text" oninput="unifiedSearch(this.value)" placeholder="ابحث عن دروس، كتب، أو اختبارات..." class="w-full bg-white dark:bg-slate-800/50 rounded-2xl py-3.5 pr-12 pl-4 outline-none dark:text-white border border-slate-200 dark:border-slate-700 focus:ring-4 focus:ring-teal-500/10 transition-all shadow-sm">
                <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                
                <div id="search-dropdown" class="absolute top-full left-0 right-0 mt-3 bg-white dark:bg-darkCard border dark:border-slate-700 rounded-[2rem] shadow-2xl hidden overflow-hidden z-50">
                    <div id="search-results-list" class="p-3"></div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="p-3 bg-white dark:bg-slate-800 rounded-2xl border dark:border-slate-700 hover:shadow-lg transition-all">
                    <i data-lucide="moon" class="dark:hidden w-5 h-5"></i>
                    <i data-lucide="sun" class="hidden dark:block w-5 h-5 text-yellow-400"></i>
                </button>
                <div id="profile-trigger" class="flex items-center gap-3 bg-white dark:bg-slate-800 p-2 pr-5 rounded-2xl border dark:border-slate-700 cursor-pointer shadow-sm hover:shadow-md transition-all" onclick="currentUser ? null : openAuthModal('login')">
                    <div class="text-right">
                        <div id="user-name-tag" class="font-black text-sm dark:text-white">دخول</div>
                        <div id="user-role-tag" class="text-[10px] text-slate-400 font-bold uppercase">طالب علم</div>
                    </div>
                    <img id="user-avatar-tag" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest" class="w-10 h-10 rounded-xl bg-teal-50 border-2 border-white dark:border-slate-700 shadow-sm">
                </div>
            </div>
        </header>

        <!-- Dynamic Pages -->
        <div class="flex-grow">
            <!-- Home -->
            <div id="page-home" class="page-content active p-6 lg:p-12">
                <div class="relative rounded-[4rem] p-16 text-white shadow-2xl shadow-teal-900/20 mb-16 overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-teal-600 via-teal-700 to-teal-900"></div>
                    <div class="absolute -right-20 -bottom-20 w-96 h-96 bg-white/10 rounded-full blur-3xl group-hover:bg-white/20 transition-all duration-700"></div>
                    <div class="relative z-10">
                        <span class="inline-block px-4 py-1.5 bg-white/20 rounded-full text-xs font-black tracking-widest uppercase mb-6">أكاديمية واد الرمان</span>
                        <h1 class="text-6xl font-black mb-6 leading-tight">بوابتك لتعلم <br><span class="text-teal-200">العلوم الشرعية</span></h1>
                        <p class="text-xl text-teal-50 max-w-xl opacity-80 leading-relaxed mb-10">منصة تفاعلية متكاملة تجمع بين أصالة المحتوى وحداثة التجربة التعليمية.</p>
                        <div class="flex gap-4">
                            <button onclick="protectedNavigation('subjects')" class="bg-white text-teal-900 px-8 py-4 rounded-2xl font-black shadow-xl hover:scale-105 transition-transform">ابدأ التعلم الآن</button>
                            <button onclick="protectedNavigation('library')" class="bg-teal-500/30 backdrop-blur-md text-white px-8 py-4 rounded-2xl font-black border border-white/10 hover:bg-teal-500/40 transition-all">تصفح المكتبة</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="glass-card p-10 rounded-[3rem] text-center">
                        <div class="w-20 h-20 bg-teal-100 dark:bg-teal-900/30 rounded-3xl flex items-center justify-center text-teal-600 mx-auto mb-8 shadow-inner"><i data-lucide="book-marked" class="w-10 h-10"></i></div>
                        <h3 class="text-2xl font-black mb-4 dark:text-white">منهج مؤصل</h3>
                        <p class="text-slate-500 leading-relaxed">دروس منتقاة في العقيدة، الفقه، والسيرة النبوية بأقلام العلماء.</p>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] text-center">
                        <div class="w-20 h-20 bg-amber-100 dark:bg-amber-900/30 rounded-3xl flex items-center justify-center text-amber-600 mx-auto mb-8 shadow-inner"><i data-lucide="gauge" class="w-10 h-10"></i></div>
                        <h3 class="text-2xl font-black mb-4 dark:text-white">تفاعل ذكي</h3>
                        <p class="text-slate-500 leading-relaxed">أنظمة اختبارات وتحديات وقت لتعزيز الفهم وسرعة الاستحضار.</p>
                    </div>
                    <div class="glass-card p-10 rounded-[3rem] text-center">
                        <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 rounded-3xl flex items-center justify-center text-blue-600 mx-auto mb-8 shadow-inner"><i data-lucide="graduation-cap" class="w-10 h-10"></i></div>
                        <h3 class="text-2xl font-black mb-4 dark:text-white">شهادات تميز</h3>
                        <p class="text-slate-500 leading-relaxed">كن من المتصدرين واحصل على مراتب عليا في لوحة شرف المنصة.</p>
                    </div>
                </div>
            </div>

            <!-- Subjects -->
            <div id="page-subjects" class="page-content p-6 lg:p-12">
                <div class="flex items-end justify-between mb-12">
                    <div>
                        <h1 class="text-4xl font-black dark:text-white mb-2 tracking-tight">المواد التعليمية</h1>
                        <p class="text-slate-500 font-medium">اختر المادة وابدأ رحلتك في طلب العلم</p>
                    </div>
                </div>
                <div id="subjects-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8"></div>
            </div>

            <!-- Quizzes -->
            <div id="page-quizzes" class="page-content p-6 lg:p-12">
                <div class="text-center mb-16">
                    <h1 class="text-4xl font-black dark:text-white mb-4">اختبر معلوماتك</h1>
                    <p class="text-slate-500 max-w-2xl mx-auto">مجموعة متنوعة من الاختبارات التقييمية لقياس مدى استيعابك للمواد الشرعية.</p>
                </div>
                <div id="quizzes-grid" class="grid grid-cols-1 md:grid-cols-3 gap-10"></div>
            </div>

            <!-- Library -->
            <div id="page-library" class="page-content p-6 lg:p-12">
                <div class="flex items-center gap-6 mb-16 p-8 bg-amber-50 dark:bg-amber-900/10 rounded-[3rem] border border-amber-100 dark:border-amber-900/20">
                    <div class="w-20 h-20 bg-amber-600 rounded-[2rem] flex items-center justify-center text-white shadow-xl shadow-amber-600/20">
                        <i data-lucide="bookmark" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h1 class="text-4xl font-black dark:text-white mb-1">المكتبة الرقمية</h1>
                        <p class="text-amber-800 dark:text-amber-500 font-bold opacity-80">كنوز من أمهات الكتب الإسلامية بين يديك</p>
                    </div>
                </div>
                <div id="books-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-10"></div>
            </div>

            <!-- Leaderboard -->
            <div id="page-leaderboard" class="page-content p-6 lg:p-12">
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-12">
                        <div class="inline-block p-4 bg-yellow-100 dark:bg-yellow-900/30 rounded-3xl mb-4">
                            <i data-lucide="trophy" class="w-12 h-12 text-yellow-600"></i>
                        </div>
                        <h1 class="text-4xl font-black dark:text-white mb-2">لوحة الشرف</h1>
                        <p class="text-slate-500">أفضل الطلاب تفاعلاً وإنجازاً</p>
                    </div>
                    <div id="leaderboard-list" class="space-y-4"></div>
                </div>
            </div>

            <!-- Challenge -->
            <div id="page-challenge" class="page-content p-6 lg:p-12">
                <div id="game-container" class="max-w-3xl mx-auto">
                    <div id="game-start" class="glass-card rounded-[4rem] p-20 text-center">
                        <i data-lucide="timer" class="w-20 h-20 text-teal-600 mx-auto mb-8"></i>
                        <h2 class="text-4xl font-black mb-4 dark:text-white">تحدي الوقت</h2>
                        <p class="text-slate-500 text-lg mb-12 leading-relaxed">استعد للإجابة على أكبر عدد ممكن من الأسئلة في 30 ثانية. كل إجابة صحيحة تمنحك 10 نقاط!</p>
                        <button onclick="startGame()" class="bg-teal-600 text-white px-16 py-5 rounded-[2rem] font-black text-xl hover:bg-teal-700 transition-all shadow-xl shadow-teal-600/20">ابدأ الآن</button>
                    </div>

                    <div id="game-active" class="hidden glass-card rounded-[4rem] p-12 shadow-2xl">
                        <div class="flex justify-between items-center mb-12">
                            <div class="flex items-center gap-3 bg-teal-50 dark:bg-teal-900/20 px-6 py-3 rounded-2xl border border-teal-200 dark:border-teal-800">
                                <i data-lucide="star" class="w-6 h-6 text-teal-600"></i>
                                <span class="text-teal-600 font-black text-3xl" id="game-score">0</span>
                            </div>
                            <div class="flex items-center gap-3 bg-rose-50 dark:bg-rose-900/20 px-6 py-3 rounded-2xl border border-rose-200 dark:border-rose-800">
                                <i data-lucide="clock" class="w-6 h-6 text-rose-600"></i>
                                <span class="text-rose-600 font-black text-3xl" id="game-timer">30</span>
                            </div>
                        </div>
                        <div id="question-area" class="text-center">
                            <h3 id="current-question" class="text-3xl font-black dark:text-white mb-12 leading-tight"></h3>
                            <div id="answers-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                        </div>
                    </div>

                    <div id="game-result" class="hidden glass-card rounded-[4rem] p-20 text-center">
                        <i data-lucide="party-popper" class="w-20 h-20 text-teal-600 mx-auto mb-6"></i>
                        <h2 class="text-4xl font-black mb-2 dark:text-white">انتهى الوقت!</h2>
                        <p class="text-slate-500 mb-8">لقد قمت بعمل رائع</p>
                        <div class="text-8xl font-black text-teal-600 mb-12" id="final-score">0</div>
                        <button onclick="startGame()" class="bg-teal-600 text-white px-12 py-4 rounded-2xl font-bold hover:bg-teal-700 transition-all">حاول مرة أخرى</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const platformData = {
            subjects: [
                { id: 's1', type: 'subject', title: 'شرح العقيدة الواسطية', desc: 'تأصيل أصول الإيمان بأسلوب ميسر للمبتدئين.', tutor: 'د. عبدالله بن فهد', progress: 45, icon: 'shield-check', color: 'teal' },
                { id: 's2', type: 'subject', title: 'كتاب الطهارة والصلاة', desc: 'أهم الأحكام الفقهية التي لا يسع المسلم جهلها.', tutor: 'الشيخ محمد الراجحي', progress: 80, icon: 'droplets', color: 'blue' },
                { id: 's3', type: 'subject', title: 'تاريخ تدوين القرآن', desc: 'كيف وصل إلينا كتاب الله غضاً طرياً كما أنزل.', tutor: 'د. إبراهيم الماجد', progress: 15, icon: 'scroll', color: 'amber' },
                { id: 's4', type: 'subject', title: 'الأربعون النووية', desc: 'شرح جوامع كلم النبي ﷺ ومعانيها العظيمة.', tutor: 'الشيخ صالح السند', progress: 60, icon: 'message-circle', color: 'rose' }
            ],
            books: [
                { id: 'b1', type: 'book', title: 'رياض الصالحين', author: 'الإمام النووي', cover: 'bg-emerald-700' },
                { id: 'b2', type: 'book', title: 'زاد المعاد', author: 'ابن القيم الجوزية', cover: 'bg-amber-800' },
                { id: 'b3', type: 'book', title: 'الرحيق المختوم', author: 'صفي الرحمن', cover: 'bg-rose-800' },
                { id: 'b4', type: 'book', title: 'صحيح البخاري', author: 'محمد بن إسماعيل', cover: 'bg-indigo-900' },
                { id: 'b5', type: 'book', title: 'تفسير السعدي', author: 'عبدالرحمن السعدي', cover: 'bg-teal-800' }
            ],
            quizzes: [
                { id: 'q1', type: 'quiz', title: 'أساسيات السيرة النبوية', desc: 'اختبر حصيلتك في أحداث العهد المكي والمدني.', questions: 15, color: 'emerald' },
                { id: 'q2', type: 'quiz', title: 'فقه المعاملات المالية', desc: 'اختبر فهمك للبيوع المحرمة والبيوع الصحيحة.', questions: 10, color: 'blue' },
                { id: 'q3', type: 'quiz', title: 'علوم مصطلح الحديث', desc: 'مبادئ قبول الحديث ورده وأنواع السند.', questions: 20, color: 'purple' }
            ],
            gameQuestions: [
                { q: "من هو أول الأنبياء بعد آدم؟", a: ["إدريس عليه السلام", "نوح عليه السلام", "شيث عليه السلام", "صالح عليه السلام"], correct: 2 },
                { q: "ما هي أطول سورة في القرآن الكريم؟", a: ["آل عمران", "البقرة", "النساء", "المائدة"], correct: 1 },
                { q: "كم عدد الخلفاء الراشدين؟", a: ["3", "4", "5", "6"], correct: 1 },
                { q: "أين ولد النبي محمد ﷺ؟", a: ["المدينة", "مكة المكرمة", "الطائف", "خيبر"], correct: 1 },
                { q: "ما هي السورة التي تسمى عروس القرآن؟", a: ["الفاتحة", "يس", "الرحمن", "الملك"], correct: 2 },
                { q: "كم سنة استمرت الدعوة النبوية؟", a: ["10 سنوات", "13 سنة", "23 سنة", "40 سنة"], correct: 2 }
            ]
        };

        let currentUser = null;
        let registeredUsers = [{ name: "إبراهيم", email: "ibrahim@example.com", pass: "123", score: 1500 }];
        let leaderboard = [
            { name: "فاطمة الزهراء", score: 2850 },
            { name: "إبراهيم", score: 1500 },
            { name: "أحمد بن علي", score: 1240 },
            { name: "سارة محمد", score: 980 }
        ];

        // --- Auth Core ---
        function openAuthModal(mode) {
            const modal = document.getElementById('auth-modal');
            modal.classList.remove('invisible', 'opacity-0');
            toggleAuthForms(mode);
        }

        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            modal.classList.add('invisible', 'opacity-0');
        }

        function toggleAuthForms(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('signup-form').classList.toggle('hidden', mode !== 'signup');
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            const user = registeredUsers.find(u => u.email === email && u.pass === pass);
            if (user) {
                currentUser = user;
                showToast(`أهلاً بك مجدداً يا ${user.name}`, 'success');
                updateAuthUI(); closeAuthModal();
            } else {
                showToast('البريد أو كلمة المرور غير صحيحة', 'error');
            }
        }

        function handleSignup() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            if(!name || !email || !pass) return showToast('يرجى ملء جميع الحقول', 'error');
            const newUser = { name, email, pass, score: 0 };
            registeredUsers.push(newUser);
            currentUser = newUser;
            showToast('تم إنشاء حسابك بنجاح', 'success');
            updateAuthUI(); closeAuthModal();
        }

        function logout() {
            currentUser = null;
            showToast('تم تسجيل الخروج بنجاح', 'success');
            updateAuthUI();
            navigateTo('home');
        }

        function updateAuthUI() {
            const tag = document.getElementById('user-name-tag');
            const avatar = document.getElementById('user-avatar-tag');
            const actions = document.getElementById('auth-sidebar-actions');
            if(currentUser) {
                tag.innerText = currentUser.name;
                avatar.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentUser.name}`;
                actions.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="bg-teal-100 dark:bg-teal-900/30 p-3 rounded-xl flex justify-between items-center mb-2">
                            <span class="text-[10px] font-black text-teal-600 uppercase">نقاطي</span>
                            <span class="font-black text-teal-700 dark:text-teal-400">${currentUser.score}</span>
                        </div>
                        <button onclick="logout()" class="w-full bg-rose-50 dark:bg-rose-900/10 text-rose-600 py-3.5 rounded-2xl font-black text-sm hover:bg-rose-100 transition-all border border-rose-100 dark:border-rose-900/30">تسجيل الخروج</button>
                    </div>
                `;
            } else {
                tag.innerText = "دخول";
                avatar.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=Guest`;
                actions.innerHTML = `<button onclick="openAuthModal('login')" class="w-full bg-teal-600 text-white py-4 rounded-2xl font-black text-sm hover:bg-teal-700 shadow-xl shadow-teal-600/20 transition-all">انضم لطلاب العلم</button>`;
            }
        }

        // --- Navigation ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            const target = document.getElementById('page-' + pageId);
            if (target) target.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
            const activeNav = document.getElementById('nav-' + pageId);
            if(activeNav) activeNav.classList.add('active-nav');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function protectedNavigation(pageId) {
            if(!currentUser) {
                showToast('يرجى تسجيل الدخول للوصول لهذا المحتوى', 'error');
                openAuthModal('login');
                return;
            }
            navigateTo(pageId);
        }

        // --- Search ---
        function unifiedSearch(val) {
            const dropdown = document.getElementById('search-dropdown');
            const list = document.getElementById('search-results-list');
            if (val.length < 1) { dropdown.classList.add('hidden'); return; }

            const results = [
                ...platformData.subjects,
                ...platformData.books,
                ...platformData.quizzes
            ].filter(item => item.title.includes(val));

            if (results.length > 0) {
                dropdown.classList.remove('hidden');
                list.innerHTML = results.slice(0, 5).map(res => `
                    <div onclick="protectedNavigation('${res.type === 'quiz' ? 'quizzes' : (res.type === 'book' ? 'library' : 'subjects')}')" class="p-4 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer flex items-center gap-4 rounded-2xl transition-colors">
                        <div class="w-10 h-10 bg-teal-100 dark:bg-teal-900/30 rounded-xl flex items-center justify-center text-teal-600">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <div class="font-black dark:text-white text-sm">${res.title}</div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">${res.type}</div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // --- Renderers ---
        function renderSubjects() {
            document.getElementById('subjects-grid').innerHTML = platformData.subjects.map(s => `
                <div class="glass-card p-8 rounded-[3rem] group">
                    <div class="w-14 h-14 bg-${s.color}-100 dark:bg-${s.color}-900/30 rounded-2xl flex items-center justify-center text-${s.color}-600 mb-6 group-hover:scale-110 transition-transform">
                        <i data-lucide="${s.icon}" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-xl font-black mb-2 dark:text-white">${s.title}</h3>
                    <p class="text-sm text-slate-500 mb-6 leading-relaxed line-clamp-2">${s.desc}</p>
                    <div class="flex items-center justify-between mb-4 text-xs font-bold text-slate-400">
                        <span>إكمال المادة</span>
                        <span class="text-teal-600">${s.progress}%</span>
                    </div>
                    <div class="w-full h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div class="h-full bg-teal-500 rounded-full" style="width: ${s.progress}%"></div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderBooks() {
            document.getElementById('books-grid').innerHTML = platformData.books.map(b => `
                <div class="group cursor-pointer">
                    <div class="book-spine aspect-[2/3] ${b.cover} rounded-xl shadow-xl mb-4 flex flex-col justify-end p-4 text-white overflow-hidden relative">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                        <div class="relative z-10">
                            <div class="text-xs font-bold opacity-60 mb-1">${b.author}</div>
                            <div class="text-lg font-black leading-tight">${b.title}</div>
                        </div>
                    </div>
                    <button class="w-full py-2 text-sm font-bold text-slate-400 hover:text-teal-600 transition-colors">تصفح الكتاب</button>
                </div>
            `).join('');
        }

        function renderQuizzes() {
            document.getElementById('quizzes-grid').innerHTML = platformData.quizzes.map(q => `
                <div class="glass-card p-10 rounded-[3rem] border-b-8 border-b-${q.color}-500/20">
                    <div class="flex justify-between items-start mb-8">
                        <div class="w-12 h-12 bg-${q.color}-100 dark:bg-${q.color}-900/30 rounded-xl flex items-center justify-center text-${q.color}-600">
                            <i data-lucide="help-circle" class="w-6 h-6"></i>
                        </div>
                        <span class="bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full text-[10px] font-black text-slate-500">${q.questions} سؤال</span>
                    </div>
                    <h3 class="text-2xl font-black mb-4 dark:text-white">${q.title}</h3>
                    <p class="text-slate-500 mb-8 text-sm leading-relaxed">${q.desc}</p>
                    <button class="w-full bg-${q.color}-600 text-white py-4 rounded-2xl font-black hover:opacity-90 transition-all shadow-lg shadow-${q.color}-600/20">بدء الاختبار</button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = leaderboard.sort((a,b) => b.score - a.score).map((u, i) => `
                <div class="flex items-center gap-6 p-6 glass-card rounded-3xl ${i === 0 ? 'ring-2 ring-yellow-400 scale-[1.02]' : ''}">
                    <div class="w-12 h-12 flex items-center justify-center font-black text-2xl ${i === 0 ? 'text-yellow-500' : (i === 1 ? 'text-slate-400' : 'text-amber-700')}">
                        ${i + 1}
                    </div>
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${u.name}" class="w-14 h-14 rounded-2xl bg-white shadow-sm border dark:border-slate-700">
                    <div class="flex-grow">
                        <div class="font-black dark:text-white text-lg">${u.name}</div>
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">طالب متميز</div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-black text-teal-600">${u.score.toLocaleString()}</div>
                        <div class="text-[10px] text-slate-400 font-bold">نقطة</div>
                    </div>
                </div>
            `).join('');
        }

        // --- Game Logic ---
        let gameTimer, timeLeft, score, currentQuestionIndex;

        function startGame() {
            document.getElementById('game-start').classList.add('hidden');
            document.getElementById('game-result').classList.add('hidden');
            document.getElementById('game-active').classList.remove('hidden');
            
            score = 0;
            timeLeft = 30;
            currentQuestionIndex = 0;
            updateGameUI();
            
            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('game-timer').innerText = timeLeft;
                if(timeLeft <= 0) endGame();
            }, 1000);
            
            showQuestion();
        }

        function showQuestion() {
            const q = platformData.gameQuestions[currentQuestionIndex % platformData.gameQuestions.length];
            document.getElementById('current-question').innerText = q.q;
            document.getElementById('answers-grid').innerHTML = q.a.map((ans, i) => `
                <button onclick="checkAnswer(${i})" class="bg-white dark:bg-slate-800 p-6 rounded-3xl font-bold text-xl border-2 border-slate-100 dark:border-slate-700 hover:border-teal-500 hover:shadow-xl hover:shadow-teal-500/5 transition-all text-right">
                    ${ans}
                </button>
            `).join('');
        }

        function checkAnswer(idx) {
            const q = platformData.gameQuestions[currentQuestionIndex % platformData.gameQuestions.length];
            if(idx === q.correct) {
                score += 10;
                showToast('+10 نقاط! إجابة صحيحة', 'success');
            } else {
                showToast('إجابة خاطئة، حاول مرة أخرى', 'error');
            }
            currentQuestionIndex++;
            updateGameUI();
            showQuestion();
        }

        function updateGameUI() {
            document.getElementById('game-score').innerText = score;
        }

        function endGame() {
            clearInterval(gameTimer);
            document.getElementById('game-active').classList.add('hidden');
            document.getElementById('game-result').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            
            if(currentUser) {
                currentUser.score += score;
                const lbUser = leaderboard.find(l => l.name === currentUser.name);
                if(lbUser) lbUser.score += score;
                else leaderboard.push({ name: currentUser.name, score: currentUser.score });
                updateAuthUI();
                renderLeaderboard();
            }
        }

        // --- Helpers ---
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 z-[200] px-8 py-4 rounded-2xl shadow-2xl transition-all duration-500 flex items-center gap-3 ${type === 'success' ? 'bg-teal-600 text-white' : 'bg-rose-600 text-white'}`;
            toastMsg.innerText = msg;
            toast.classList.remove('opacity-0', 'translate-y-20');
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-20'), 3000);
        }

        // --- Init ---
        window.onload = () => {
            lucide.createIcons();
            updateAuthUI();
            renderSubjects();
            renderBooks();
            renderQuizzes();
            renderLeaderboard();
        };
    </script>
</body>
</html>